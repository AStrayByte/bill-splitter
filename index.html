<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Uber Eats Bill Splitter</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 10px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #00c851 0%, #00a04a 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 0.9em;
      }

      .input-section {
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }

      .receipt-input {
        width: 100%;
        height: 150px;
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        font-family: monospace;
        font-size: 14px;
        resize: vertical;
        transition: border-color 0.3s;
      }

      .receipt-input:focus {
        outline: none;
        border-color: #00c851;
      }

      .parse-btn {
        background: linear-gradient(135deg, #00c851 0%, #00a04a 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
        transition: transform 0.2s;
      }

      .parse-btn:hover {
        transform: translateY(-2px);
      }

      .main-content {
        display: flex;
        flex-direction: column;
        min-height: 400px;
      }

      .items-section {
        padding: 20px;
        border-bottom: 3px solid #e9ecef;
      }

      .people-section {
        padding: 20px;
        background: #f8f9fa;
      }

      .section-title {
        font-size: 1.3em;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #00c851;
        padding-bottom: 10px;
      }

      .item {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
      }

      .item:hover {
        border-color: #00c851;
        box-shadow: 0 5px 15px rgba(0, 200, 81, 0.1);
      }

      .item-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        gap: 8px;
      }

      .item-name {
        font-weight: 600;
        color: #333;
        font-size: 1em;
      }

      .item-price {
        background: #00c851;
        color: white;
        padding: 5px 12px;
        border-radius: 15px;
        font-weight: 600;
        align-self: flex-start;
      }

      .item-details {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 15px;
        line-height: 1.4;
      }

      .person-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .person-selection span {
        width: 100%;
        margin-bottom: 5px;
        font-size: 0.85em;
        color: #666;
      }

      .person-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        color: white;
        position: relative;
        font-size: 0.9em;
      }

      .person-circle:hover {
        transform: scale(1.1);
      }

      .person-circle.selected {
        border: 4px solid #000 !important;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
      }

      .person-circle.color-0 {
        background: #ff6b6b;
      }
      .person-circle.color-1 {
        background: #4ecdc4;
      }
      .person-circle.color-2 {
        background: #9c27b0;
      }
      .person-circle.color-3 {
        background: #ff9800;
      }
      .person-circle.color-4 {
        background: #795548;
      }
      .person-circle.color-5 {
        background: #607d8b;
      }
      .person-circle.color-6 {
        background: #e91e63;
      }
      .person-circle.color-7 {
        background: #009688;
      }
      .person-circle.color-8 {
        background: #3f51b5;
      }
      .person-circle.color-9 {
        background: #8bc34a;
      }

      .add-person {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: 3px dashed #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 20px;
        color: #666;
      }

      .add-person:hover {
        border-color: #00c851;
        color: #00c851;
        transform: scale(1.1);
      }

      .summary {
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        border: 2px solid #e9ecef;
      }

      .summary h3 {
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        border-bottom: 1px solid #f1f3f4;
        font-size: 0.9em;
      }

      .summary-item:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1em;
        border-top: 2px solid #00c851;
        padding-top: 12px;
        margin-top: 8px;
      }

      .totals-section {
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        padding: 15px;
        border: 2px solid #e9ecef;
      }

      .totals-section h3 {
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .person-total {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        border-left: 4px solid;
      }

      .person-total.color-0 {
        border-left-color: #ff6b6b;
      }
      .person-total.color-1 {
        border-left-color: #4ecdc4;
      }
      .person-total.color-2 {
        border-left-color: #9c27b0;
      }
      .person-total.color-3 {
        border-left-color: #ff9800;
      }
      .person-total.color-4 {
        border-left-color: #795548;
      }
      .person-total.color-5 {
        border-left-color: #607d8b;
      }
      .person-total.color-6 {
        border-left-color: #e91e63;
      }
      .person-total.color-7 {
        border-left-color: #009688;
      }
      .person-total.color-8 {
        border-left-color: #3f51b5;
      }
      .person-total.color-9 {
        border-left-color: #8bc34a;
      }

      .person-name {
        font-weight: 600;
        font-size: 1em;
        margin-bottom: 8px;
      }

      .breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        font-size: 0.85em;
      }

      .final-total {
        font-weight: 600;
        font-size: 0.95em;
        border-top: 1px solid #dee2e6;
        padding-top: 6px;
        margin-top: 6px;
      }

      .error {
        background: #ffe6e6;
        color: #cc0000;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        border: 1px solid #ffcccc;
        font-size: 0.9em;
      }

      /* Tablet styles */
      @media (min-width: 768px) {
        body {
          padding: 15px;
        }

        .header {
          padding: 25px;
        }

        .header h1 {
          font-size: 2.2em;
        }

        .header p {
          font-size: 1em;
        }

        .input-section {
          padding: 25px;
        }

        .receipt-input {
          height: 180px;
        }

        .parse-btn {
          width: auto;
          display: inline-block;
        }

        .items-section,
        .people-section {
          padding: 25px;
        }

        .section-title {
          font-size: 1.4em;
        }

        .item-header {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          gap: 0;
        }

        .item-name {
          font-size: 1.05em;
        }

        .person-selection span {
          width: auto;
          margin-bottom: 0;
          margin-right: 10px;
          font-size: 0.9em;
        }

        .person-circle,
        .add-person {
          width: 48px;
          height: 48px;
        }

        .summary,
        .totals-section {
          padding: 18px;
        }

        .person-total {
          padding: 14px;
        }
      }

      /* Desktop styles */
      @media (min-width: 1024px) {
        body {
          padding: 20px;
        }

        .header {
          padding: 30px;
        }

        .header h1 {
          font-size: 2.5em;
        }

        .input-section {
          padding: 30px;
        }

        .receipt-input {
          height: 200px;
        }

        .main-content {
          flex-direction: row;
          min-height: 600px;
        }

        .items-section {
          flex: 1;
          padding: 30px;
          border-right: 3px solid #e9ecef;
          border-bottom: none;
        }

        .people-section {
          width: 400px;
          padding: 30px;
        }

        .section-title {
          font-size: 1.5em;
        }

        .item-name {
          font-size: 1.1em;
        }

        .person-circle,
        .add-person {
          width: 50px;
          height: 50px;
          font-size: 1em;
        }

        .add-person {
          font-size: 24px;
        }

        .summary {
          margin-top: 30px;
          padding: 20px;
        }

        .summary h3 {
          font-size: 1.2em;
        }

        .summary-item {
          padding: 8px 0;
          font-size: 1em;
        }

        .summary-item:last-child {
          font-size: 1.1em;
          padding-top: 15px;
          margin-top: 10px;
        }

        .totals-section {
          margin-top: 30px;
          padding: 20px;
        }

        .totals-section h3 {
          font-size: 1.2em;
        }

        .person-total {
          padding: 15px;
          margin-bottom: 15px;
        }

        .person-name {
          font-size: 1.1em;
          margin-bottom: 10px;
        }

        .breakdown-item {
          padding: 3px 0;
          font-size: 0.9em;
        }

        .final-total {
          font-size: 1.1em;
          padding-top: 8px;
          margin-top: 8px;
        }
      }

      /* Large desktop styles */
      @media (min-width: 1200px) {
        .people-section {
          width: 450px;
        }
      }

      /* Touch-friendly improvements for mobile */
      @media (max-width: 767px) {
        .person-circle,
        .add-person {
          min-height: 44px;
          min-width: 44px;
        }

        .parse-btn {
          min-height: 44px;
        }

        /* Ensure text doesn't get too small */
        .breakdown-item,
        .summary-item {
          min-height: 32px;
          align-items: center;
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .person-circle,
        .add-person {
          border-width: 2px;
        }

        .person-circle.selected {
          border-width: 3px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üçî Uber Eats Bill Splitter</h1>
        <p>Paste your receipt and split the bill fairly!</p>
      </div>

      <div class="input-section">
        <textarea
          class="receipt-input"
          placeholder="Paste your Uber Eats receipt here...

Example:
Total	$99.98
You saved $13.17 on this order with Uber One and promos
 
1
KALAMAKIA PORK KABOBS
$16.53
 	KALAMAKIA PORK KABOBS MODS
 	No Tzatziki** $0.00
 	#Extra Pita Bread $1.00
 	Mini Kabob Size
 	3-Three $15.53
1
RICE
$5.18
..."
        ></textarea>
        <button class="parse-btn" onclick="parseReceipt()">
          Parse Receipt
        </button>
        <div id="error-message"></div>
      </div>

      <div class="main-content">
        <div class="items-section">
          <h2 class="section-title">üìã Order Items</h2>
          <div id="items-container"></div>
        </div>

        <div class="people-section">
          <h2 class="section-title">üë• People & Totals</h2>

          <div class="summary">
            <h3>üìä Order Summary</h3>
            <div id="order-summary"></div>
          </div>

          <div class="totals-section">
            <h3>üí∞ Individual Totals</h3>
            <div id="individual-totals"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let receiptData = {
        items: [],
        subtotal: 0,
        fees: {},
        discounts: {},
        total: 0,
      };

      let people = [
        { id: 1, name: "Person 1", colorIndex: 0 },
        { id: 2, name: "Person 2", colorIndex: 1 },
      ];

      let itemAssignments = {}; // itemIndex -> personId

      function parseReceipt() {
        const input = document.querySelector(".receipt-input").value;
        const errorDiv = document.getElementById("error-message");

        if (!input.trim()) {
          showError("Please paste your Uber Eats receipt");
          return;
        }

        try {
          parseReceiptText(input);
          renderItems();
          updateTotals();
          errorDiv.innerHTML = "";
        } catch (error) {
          showError("Error parsing receipt: " + error.message);
        }
      }

      function parseReceiptText(text) {
        const lines = text
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line);

        receiptData = {
          items: [],
          subtotal: 0,
          fees: {},
          discounts: {},
          total: 0,
        };

        let currentItem = null;
        let inItemSection = false;
        let inFeesSection = false;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // Skip header info
          if (line.includes("Total") && line.includes("$") && !inFeesSection) {
            const match = line.match(/\$(\d+\.\d{2})/);
            if (match) {
              receiptData.total = parseFloat(match[1]);
            }
            continue;
          }

          if (line.includes("You saved") || line.includes("promos")) {
            inItemSection = true;
            continue;
          }

          // Check for quantity at start of line (just a number)
          if (/^\d+$/.test(line) && inItemSection && !inFeesSection) {
            // Save previous item if exists
            if (currentItem) {
              receiptData.items.push(currentItem);
            }

            const quantity = parseInt(line);
            const nextLine = lines[i + 1];
            const priceLine = lines[i + 2];

            if (nextLine && priceLine) {
              const priceMatch = priceLine.match(/\$(\d+\.\d{2})/);
              if (priceMatch) {
                currentItem = {
                  quantity: quantity,
                  name: nextLine,
                  price: parseFloat(priceMatch[1]),
                  modifications: [],
                };
                i += 2; // Skip the name and price lines
              }
            }
            continue;
          }

          // Check for modifications (lines that start with whitespace or special chars)
          if (
            currentItem &&
            (line.startsWith(" ") ||
              line.startsWith("\t") ||
              line.startsWith("#"))
          ) {
            currentItem.modifications.push(line.trim());
            continue;
          }

          // Check for fee section indicators
          if (line.includes("Subtotal")) {
            if (currentItem) {
              receiptData.items.push(currentItem);
              currentItem = null;
            }
            inItemSection = false;
            inFeesSection = true;

            const match = line.match(/\$(\d+\.\d{2})/);
            if (match) {
              receiptData.subtotal = parseFloat(match[1]);
            }
            continue;
          }

          // Parse fees and discounts
          if (inFeesSection) {
            const feeMatch = line.match(/^(.+?)\s+\$(\d+\.\d{2})$/);
            const discountMatch = line.match(/^(.+?)\s+-\$(\d+\.\d{2})$/);

            if (feeMatch) {
              const [, name, amount] = feeMatch;
              receiptData.fees[name.trim()] = parseFloat(amount);
            } else if (discountMatch) {
              const [, name, amount] = discountMatch;
              receiptData.discounts[name.trim()] = parseFloat(amount);
            }
          }
        }

        // Add the last item if exists
        if (currentItem) {
          receiptData.items.push(currentItem);
        }

        if (receiptData.items.length === 0) {
          throw new Error("No items found in receipt");
        }
      }

      function renderItems() {
        const container = document.getElementById("items-container");
        container.innerHTML = "";

        receiptData.items.forEach((item, index) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "item";

          const modifications =
            item.modifications.length > 0
              ? `<div class="item-details">${item.modifications.join(
                  "<br>"
                )}</div>`
              : "";

          itemDiv.innerHTML = `
                    <div class="item-header">
                        <span class="item-name">${item.quantity}x ${
            item.name
          }</span>
                        <span class="item-price">$${item.price.toFixed(
                          2
                        )}</span>
                    </div>
                    ${modifications}
                    <div class="person-selection">
                        <span>Assign to:</span>
                        ${people
                          .map(
                            (person) => `
                            <div class="person-circle color-${
                              person.colorIndex
                            } ${
                              itemAssignments[index] === person.id
                                ? "selected"
                                : ""
                            }" 
                                 onclick="assignItem(${index}, ${person.id})">
                                ${person.id}
                            </div>
                        `
                          )
                          .join("")}
                        <div class="add-person" onclick="addPerson()">+</div>
                    </div>
                `;

          container.appendChild(itemDiv);
        });
      }

      function assignItem(itemIndex, personId) {
        if (itemAssignments[itemIndex] === personId) {
          // Unassign if clicking the same person
          delete itemAssignments[itemIndex];
        } else {
          itemAssignments[itemIndex] = personId;
        }
        renderItems();
        updateTotals();
      }

      function addPerson() {
        const newId = people.length + 1;
        const newColorIndex = people.length; // This will give us the next color in sequence
        people.push({
          id: newId,
          name: `Person ${newId}`,
          colorIndex: newColorIndex % 10, // Cycle through 10 colors
        });
        renderItems();
        updateTotals();
      }

      function updateTotals() {
        updateOrderSummary();
        updateIndividualTotals();
      }

      function updateOrderSummary() {
        const container = document.getElementById("order-summary");

        const totalFees = Object.values(receiptData.fees).reduce(
          (sum, fee) => sum + fee,
          0
        );
        const totalDiscounts = Object.values(receiptData.discounts).reduce(
          (sum, discount) => sum + discount,
          0
        );

        let html = `
                <div class="summary-item">
                    <span>Subtotal:</span>
                    <span>$${receiptData.subtotal.toFixed(2)}</span>
                </div>
            `;

        // Add fees
        Object.entries(receiptData.fees).forEach(([name, amount]) => {
          html += `
                    <div class="summary-item">
                        <span>${name}:</span>
                        <span>$${amount.toFixed(2)}</span>
                    </div>
                `;
        });

        // Add discounts
        Object.entries(receiptData.discounts).forEach(([name, amount]) => {
          html += `
                    <div class="summary-item">
                        <span>${name}:</span>
                        <span>-$${amount.toFixed(2)}</span>
                    </div>
                `;
        });

        html += `
                <div class="summary-item">
                    <span>Total:</span>
                    <span>$${receiptData.total.toFixed(2)}</span>
                </div>
            `;

        container.innerHTML = html;
      }

      function updateIndividualTotals() {
        const container = document.getElementById("individual-totals");

        // Calculate each person's totals
        const personTotals = {};
        const totalFees = Object.values(receiptData.fees).reduce(
          (sum, fee) => sum + fee,
          0
        );
        const totalDiscounts = Object.values(receiptData.discounts).reduce(
          (sum, discount) => sum + discount,
          0
        );

        people.forEach((person) => {
          personTotals[person.id] = {
            name: person.name,
            colorIndex: person.colorIndex,
            itemsTotal: 0,
            items: [],
          };
        });

        // Calculate food totals for each person
        receiptData.items.forEach((item, index) => {
          const assignedTo = itemAssignments[index];
          if (assignedTo && personTotals[assignedTo]) {
            personTotals[assignedTo].itemsTotal += item.price;
            personTotals[assignedTo].items.push(item);
          }
        });

        // Calculate proportional fees and discounts
        let html = "";

        Object.entries(personTotals).forEach(([personId, data]) => {
          if (data.itemsTotal > 0) {
            const proportion = data.itemsTotal / receiptData.subtotal;
            const personFees = totalFees * proportion;
            const personDiscounts = totalDiscounts * proportion;
            const finalTotal = data.itemsTotal + personFees - personDiscounts;

            html += `
                        <div class="person-total color-${data.colorIndex}">
                            <div class="person-name">${data.name}</div>
                            <div class="breakdown-item">
                                <span>Food Total:</span>
                                <span>$${data.itemsTotal.toFixed(2)}</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Share of Fees (${(
                                  proportion * 100
                                ).toFixed(1)}%):</span>
                                <span>$${personFees.toFixed(2)}</span>
                            </div>
                            <div class="breakdown-item">
                                <span>Share of Discounts:</span>
                                <span>-$${personDiscounts.toFixed(2)}</span>
                            </div>
                            <div class="breakdown-item final-total">
                                <span>Total to Pay:</span>
                                <span>$${finalTotal.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
          }
        });

        if (!html) {
          html =
            '<p style="text-align: center; color: #666; font-style: italic;">Assign items to people to see totals</p>';
        }

        container.innerHTML = html;
      }

      function showError(message) {
        const errorDiv = document.getElementById("error-message");
        errorDiv.innerHTML = `<div class="error">${message}</div>`;
      }

      // Initialize empty state
      updateTotals();
    </script>
  </body>
</html>
